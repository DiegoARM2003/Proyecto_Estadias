<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Panel de Administración</title>
  <link rel="stylesheet" href="css/pantalla_principal.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>
<body>

  <header>
    <h2 id="welcome-text">Bienvenido</h2>
    <div style="display: flex; gap: 20px;">
      <a href="/cuarta_pantalla.html" style="color: white; text-decoration: none;"><strong>SP'S Fecha</strong></a>
      <a href="/terciaria.html" style="color: white; text-decoration: none;"><strong>Fabricadas</strong></a>
      <a href="/login.html" style="color: white; text-decoration: none;"><strong>Cerrar sesión</strong></a>
    </div>
  </header>

  <!-- Botones alineados a la derecha -->
  <div class="admin-buttons">
      <button id="btn-agregar"><i class="fas fa-check"></i> <strong>AGREGAR</strong></button>
      <button id="btn-actualizar"><i class="fas fa-sync-alt"></i> <strong>ACTUALIZAR</strong></button>
      <button id="btn-nuevo"><i class="fas fa-plus"></i> <strong>NUEVO</strong></button>
  </div>

   <!-- Modal Nuevo -->
<div id="modal-nuevo" class="modal">
  <div class="modal-content">
    <h2>Agregar nuevo SP</h2>
    <form id="form-sp">
      <label>Clave SP:</label>
      <input type="text" name="Clave_Sp" required />

      <label>Descripción:</label>
      <input type="text" name="Descripcion" required />

      <label>Clave MP:</label>
      <input type="text" name="Clave_Mp" required />

      <label>Material:</label>
      <input type="text" name="Material" required />

      <hr>
      <div id="operaciones-container" class="operaciones-grid">
        <h3>Operaciones</h3>
      </div>

      <button type="button" id="agregar-operacion"><Strong>+ Agregar Operación</Strong></button>
      <button type="button" id="eliminar-operacion"><Strong>- Eliminar Operación</Strong></button>
      <div class="modal-buttons">
        <button type="submit"><strong>Guardar</strong></button>
        <button type="button" id="cerrar-modal"><strong>Cancelar</strong></button>
      </div>
    </form>
  </div>
</div>

<!-- Modal Agregar -->  
<div id="modal-agregar" class="modal" style="display:none;">
  <div class="modal-content">
    <h2>Agregar SP </h2>
    <form id="form-agregar-sp">

      <div class="modal-grid">
        <div class="field-group">
          <label for="select-sp">Clave Sp:</label>
          <select id="select-sp" required>
            <option value="">Seleccione SP</option>
          </select>

          <label>Descripción:</label>
          <input type="text" id="desc-sp" readonly />

          <label for="fecha-sp">Fecha:</label>
          <input type="date" id="fecha-sp" required />

          <label>Piezas Totales:</label>
          <input type="number" id="piezas-totales" required min="1" />

          <label>Clave MP:</label>
          <input type="text" id="clave-mp" readonly />
        </div>

        <div class="field-group">
          <label>Operación:</label>
          <input type="text" id="op1" readonly />

          <label>Nombre Máquina:</label>
          <input type="text" id="maquina1" readonly />

          <label>Clave Máquina:</label>
          <input type="text" id="clave1" readonly />

          <label>Tiempo Máquina:</label>
          <input type="text" id="tiempo1" readonly />

          

          <label>Material:</label>
          <input type="text" id="material" readonly />
        </div>
      </div>

      <div class="modal-buttons">
        <button type="submit"><strong>Guardar</strong></button>
        <button type="button" id="cerrar-modal-agregar"><strong>Cancelar</strong></button>
      </div>
    </form>
  </div>
</div>

<!-- Modal Actualizar -->
<div id="modal-actualizar" class="modal">
  <div class="modal-content">
    <h2>Actualizar SP</h2>
    <form id="form-actualizar-sp">
      <label>Selecciona SP:</label>
      <select id="select-actualizar" required></select>

      <label>Actualizar Clave SP:</label>
      <input type="text" id="input-clave-sp" required />

      <label>Selecciona Operación:</label>
      <select id="select-operacion" required></select>

      <label>Descripción:</label>
      <input type="text" id="input-descripcion" required />

      <div class="grid-2-cols">
        <div>
          <label>Nombre Máquina:</label>
          <input type="text" id="input-nombre-maquina" required />

          <label>Tiempo Máquina:</label>
          <input type="text" id="input-tiempo-maquina" required />

          <label>Clave MP:</label>
          <input type="text" id="input-clave-mp" required />
        </div>
        <div>
          <label>Clave Máquina:</label>
          <input type="text" id="input-clave-maquina" required />

          <label>Piezas Totales:</label>
          <input type="number" id="input-piezas-totales" required />

          <label>Material:</label>
          <input type="text" id="input-material" required />
        </div>
      </div>  

      <div class="modal-buttons">
        <button type="submit"><strong>Guardar</strong></button>
        <button type="button" id="cerrar-modal-actualizar"><strong>Cancelar</strong></button>
      </div>
    </form>
  </div>
</div>


<div class="tabla-wrapper">
  <table class="data-table">
    <thead>
      <tr>
        <th><strong>CLAVE SP</strong></th>
        <th><strong>DESCRIPCIÓN</strong></th>
        <th><strong>CLAVE MP</strong></th>
        <th><strong>MATERIAL</strong></th>
        <th><strong>OPERACIÓN</strong></th>
        <th><strong>NOMBRE MAQUINA</strong></th>
        <th><strong>CLAVE MAQUINA</strong></th>
        <th><strong>TIEMPO MAQUINA</strong></th>
        <th><strong>OPERACIÓN ACTUAL</strong></th>
        <th><strong>FECHA</strong></th>
        <th><strong>PIEZAS TOTALES</strong></th>
        <th><strong>PIEZAS FALTANTES</strong></th>
        <th><strong>PIEZAS COMPLETADAS</strong></th>
        <th><strong>PROGRESO</strong></th>
      </tr>
    </thead>
    <tbody id="tabla-registros">
      <!-- Rellenado por JS -->
    </tbody>
  </table>
</div>

<script>

  function mostrarAlertaPersonalizada(mensaje) {
  const alerta = document.createElement('div');
  alerta.textContent = mensaje;
  alerta.style.position = 'fixed';
  alerta.style.top = '20px';
  alerta.style.left = '50%';
  alerta.style.transform = 'translateX(-50%)';
  alerta.style.backgroundColor = '#ff4d4d';
  alerta.style.color = '#fff';
  alerta.style.padding = '12px 20px';
  alerta.style.borderRadius = '6px';
  alerta.style.boxShadow = '0 0 10px rgba(0,0,0,0.2)';
  alerta.style.zIndex = '9999';
  alerta.style.fontWeight = 'bold';
  document.body.appendChild(alerta);

  setTimeout(() => {
    alerta.remove();
  }, 2500);
}

  // Mostrar nombre del usuario
  const nombre = localStorage.getItem('nombre');
  const welcomeText = document.getElementById('welcome-text');
  welcomeText.textContent = nombre ? `Bienvenido, ${nombre}` : 'Bienvenido';

async function cargarRegistros() {
  try {
    const res = await fetch('/api/registros');
    if (!res.ok) {
      console.error('Error al obtener registros:', res.status);
      return;
    }
    const data = await res.json();

    const tablaBody = document.getElementById('tabla-registros');
    if (!tablaBody) {
      console.error('No se encontró <tbody id="tabla-registros"> en el HTML');
      return;
    }
    tablaBody.innerHTML = ''; // Limpia filas previas

    const spMap = new Map();
    data.forEach(registro => {
      const clave = registro.Clave_Sp;
      if (!spMap.has(clave)) {
        spMap.set(clave, {
          Clave_Sp: registro.Clave_Sp,
          Descripcion: registro.Descripcion,
          Clave_MP: registro.Clave_Mp,
          Material: registro.Material,
          Operaciones: [{
            Operacion: registro.Operacion,
            Nombre_Maquina: registro.Nombre_Maquina,
            Clave_Maquina: registro.Clave_Maquina,
            Tiempo_Maquina: registro.Tiempo_Maquina
          }],
          Operacion_Actual: registro.Operacion_Actual,
          Fecha: registro.Fecha,
          Piezas_Totales: registro.Piezas_Totales,
          Piezas_Faltantes: registro.Piezas_Faltantes,
          Piezas_Completadas: registro.Piezas_Completadas,
          Progreso: typeof registro.Progreso === 'number'
            ? registro.Progreso
            : parseFloat(registro.Progreso) || 0
        });
      } else {
        const sp = spMap.get(clave);
        sp.Operaciones.push({
          Operacion: registro.Operacion,
          Nombre_Maquina: registro.Nombre_Maquina,
          Clave_Maquina: registro.Clave_Maquina,
          Tiempo_Maquina: registro.Tiempo_Maquina
        });

        // Si faltan Clave_MP o Material, actualízalos
        if (!sp.Clave_MP && registro.Clave_MP) sp.Clave_MP = registro.Clave_MP;
        if (!sp.Material && registro.Material) sp.Material = registro.Material;
      }
    });

    // Ordenar por fecha antigua primero
    const registrosOrdenados = Array.from(spMap.values()).sort((a, b) => {
      const fechaA = a.Fecha ? new Date(a.Fecha) : new Date(0);
      const fechaB = b.Fecha ? new Date(b.Fecha) : new Date(0);
      return fechaA - fechaB; // Antiguos primero
    });

    let registrosMostrados = 0;
    const hoy = new Date().toISOString().slice(0, 10); // "YYYY-MM-DD"

    registrosOrdenados.forEach(registro => {
      const fechaRegistro = registro.Fecha ? registro.Fecha.slice(0, 10) : '';
      const mostrar = (registro.Progreso < 100) && (fechaRegistro <= hoy);

      if (mostrar) {
        registrosMostrados++;
        const operaciones = registro.Operaciones || [];
        let pasoActual = operaciones.find(op => op.Operacion === registro.Operacion_Actual);
        if (!pasoActual) {
          pasoActual = operaciones[0]; // fallback
          registro.Operacion_Actual = pasoActual?.Operacion || '';
        }
        const pasosTexto = operaciones.map((_, i) => `PASO ${i + 1}`).join('<br>');
        const progresoPorcentaje = Math.min(100, Math.max(0, Math.round(registro.Progreso)));
        const fechaTexto = registro.Fecha ? registro.Fecha.slice(0, 10).split('-').reverse().join('/') : '';

        const fila = document.createElement('tr');
        fila.innerHTML = `
          <td>${registro.Clave_Sp}</td>
          <td>${registro.Descripcion}</td>
          <td>${registro.Clave_Mp || registro.Clave_MP || ''}</td>
          <td>${registro.Material || ''}</td>
          <td>${pasosTexto}</td>
          <td>${pasoActual.Nombre_Maquina || ''}</td>
          <td>${pasoActual.Clave_Maquina || ''}</td>
          <td>${pasoActual.Tiempo_Maquina || ''} MIN</td>
          <td>${registro.Operacion_Actual || ''}</td>
          <td>${fechaTexto}</td>
          <td>${registro.Piezas_Totales}</td>
          <td>${registro.Piezas_Faltantes}</td>
          <td>${registro.Piezas_Completadas}</td>
          <td>
            <div class="progress-wrapper">
              <div class="progress-text">${progresoPorcentaje}%</div>
              <div class="progress-bar-container">
                <div class="progress-bar" style="width:${progresoPorcentaje}%;" 
                    ${progresoPorcentaje === 100 ? 'class="progress-bar red"' : ''}></div>
              </div>
            </div>
          </td>
        `;
        tablaBody.appendChild(fila);
      }
    });

    // Agregar manejador a los iconos de eliminar (solo ocultar de la tabla)
    document.querySelectorAll('.eliminar-icono').forEach(icono => {
      icono.addEventListener('click', () => {
        const fila = icono.closest('tr');
        if (fila) {
          fila.remove();
        }
      });
    });
  } catch (err) {
    console.error('Error al cargar la tabla:', err);
  }
}

  document.addEventListener('DOMContentLoaded', cargarRegistros);


  // ==== MANEJO DEL MODAL "NUEVO" ====

  const btnNuevo = document.getElementById('btn-nuevo');
  const modalNuevo = document.getElementById('modal-nuevo');
  const cerrarModalNuevo = document.getElementById('cerrar-modal');
  const form = document.getElementById('form-sp');
  const operacionesContainer = document.getElementById('operaciones-container');
  const agregarOperacionBtn = document.getElementById('agregar-operacion');
  const eliminarOperacionBtn = document.getElementById('eliminar-operacion');

  btnNuevo.addEventListener('click', () => {
    modalNuevo.style.display = 'flex';
    operacionesContainer.innerHTML = '';
    agregarOperacion(); // al menos una operación por defecto
  });

  cerrarModalNuevo.addEventListener('click', () => {
    modalNuevo.style.display = 'none';
  });

  agregarOperacionBtn.addEventListener('click', agregarOperacion);
  eliminarOperacionBtn.addEventListener('click', eliminarOperacion);

  function agregarOperacion() {
    const div = document.createElement('div');
    div.classList.add('operacion-box');
    div.innerHTML = `
      <label>Operación:</label>
      <input type="text" name="Operacion" required>
      <label>Nombre Máquina:</label>
      <input type="text" name="Nombre_Maquina" required>
      <label>Clave Máquina:</label>
      <input type="text" name="Clave_Maquina" required>
      <label>Tiempo Máquina:</label>
      <input type="text" name="Tiempo_Maquina" required>
    `;
    operacionesContainer.appendChild(div);
  }

  function eliminarOperacion() {
  const operaciones = document.querySelectorAll('.operacion-box');
  if (operaciones.length > 1) {
    operaciones[operaciones.length - 1].remove();
  } else {
    mostrarAlertaPersonalizada('Debe haber al menos una operación registrada.');
  }
}

  form.addEventListener('submit', async (e) => {
    e.preventDefault();

    const formData = new FormData(form);
    const sp = {
      Clave_Sp: formData.get('Clave_Sp'),
      Descripcion: formData.get('Descripcion'),
      Clave_Mp: formData.get('Clave_Mp'),  // ✅ Clave correcta
      Material: formData.get('Material'),
      Operaciones: []
    };

    const ops = operacionesContainer.querySelectorAll('div');
    ops.forEach(op => {
      const inputs = op.querySelectorAll('input');
      sp.Operaciones.push({
        Operacion: inputs[0].value,
        Nombre_Maquina: inputs[1].value,
        Clave_Maquina: inputs[2].value,
        Tiempo_Maquina: inputs[3].value
      });
    });

    try {
      const res = await fetch('/api/sp', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(sp)
      });

      if (res.ok) {
        form.reset();
        modalNuevo.style.display = 'none';
        await cargarRegistros();
        await llenarSelectSp('select-agregar');
        await llenarSelectSp('select-actualizar');
      } else {
        alert('Error al guardar el SP');
      }
    } catch (err) {
      console.error('Error al enviar SP:', err);
    }
  });

// MODAL AGREGAR A LA TABLA //
const btnAgregar = document.getElementById('btn-agregar'); 
const modalAgregar = document.getElementById('modal-agregar');
const cerrarModalAgregar = document.getElementById('cerrar-modal-agregar');

const selectSp = document.getElementById('select-sp');
const descSp = document.getElementById('desc-sp');
const piezasTotales = document.getElementById('piezas-totales');

const op1 = document.getElementById('op1');
const maquina1 = document.getElementById('maquina1');
const clave1 = document.getElementById('clave1');
const tiempo1 = document.getElementById('tiempo1');

// NUEVOS CAMPOS
const claveMp = document.getElementById('clave-mp');
const material = document.getElementById('material');

btnAgregar.addEventListener('click', async () => {
  modalAgregar.style.display = 'flex';
  await cargarSPsEnSelect();
  limpiarCampos();
});

cerrarModalAgregar.addEventListener('click', () => {
  modalAgregar.style.display = 'none';
  document.getElementById('form-agregar-sp').reset();
  limpiarCampos();
});

async function cargarSPsEnSelect() {
  try {
    const res = await fetch('/api/sp');
    const sps = await res.json();

    // Ordenar por valor numérico de Clave_Sp
    sps.sort((a, b) => parseInt(a.Clave_Sp) - parseInt(b.Clave_Sp));

    selectSp.innerHTML = '<option value="">Seleccione...</option>';

    sps.forEach(sp => {
      const option = document.createElement('option');
      option.value = sp.Clave_Sp;
      option.textContent = sp.Clave_Sp;
      selectSp.appendChild(option);
    });
  } catch (err) {
    console.error('Error al cargar SPs:', err);
  }
}

function limpiarCampos() {
  descSp.value = '';
  piezasTotales.value = '';
  op1.value = '';
  maquina1.value = '';
  clave1.value = '';
  tiempo1.value = '';
  claveMp.value = '';
  material.value = '';
}

selectSp.addEventListener('change', async () => {
  const clave = selectSp.value;
  if (!clave) return limpiarCampos();

  try {
    const res = await fetch(`/api/sp/${clave}`);
    const sp = await res.json();

    descSp.value = sp.Descripcion || '';
    op1.value = sp.Operaciones?.map(op => op.Operacion).join(', ') || '';
    maquina1.value = sp.Operaciones?.[0]?.Nombre_Maquina || '';
    clave1.value = sp.Operaciones?.[0]?.Clave_Maquina || '';
    tiempo1.value = sp.Operaciones?.[0]?.Tiempo_Maquina || '';

    // ASIGNAR CLAVE_MP Y MATERIAL
    claveMp.value = sp.Clave_Mp || '';
    material.value = sp.Material || '';
  } catch (err) {
    console.error('Error al obtener SP:', err);
  }
});

document.getElementById('form-agregar-sp').addEventListener('submit', async (e) => {
  e.preventDefault();
  const clave = selectSp.value;
  const piezas = parseInt(piezasTotales.value);
  const fecha = document.getElementById('fecha-sp').value;

  if (!clave || isNaN(piezas) || piezas <= 0 || !fecha) {
    return alert('Completa todos los campos, incluyendo la fecha.');
  }

  try {
    const res = await fetch(`/api/sp/piezas/${clave}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ piezasTotales: piezas, fecha })
    });

    if (res.ok) {
      alert('SP agregado correctamente');
      modalAgregar.style.display = 'none';
      document.getElementById('form-agregar-sp').reset();
      limpiarCampos();
      await cargarRegistros();
    } else {
      alert('Error al guardar SP');
    }
  } catch (err) {
    console.error('Error al guardar:', err);
  }
});


// Modal actualizar//  
async function llenarSelectSp(selectId) {
  try {
    const res = await fetch('/api/sp');
    const data = await res.json();
    const select = document.getElementById(selectId);

    select.innerHTML = '<option value="">Seleccione un SP</option>';

    data.forEach(sp => {
      const option = document.createElement('option');
      option.value = sp.Clave_Sp;
      option.textContent = sp.Clave_Sp;
      select.appendChild(option);
    });
  } catch (error) {
    console.error('Error al llenar el select:', error);
  }
}

const modalActualizar = document.getElementById('modal-actualizar');
const btnActualizar = document.getElementById('btn-actualizar');
const cerrarModalActualizar = document.getElementById('cerrar-modal-actualizar');
const selectActualizar = document.getElementById('select-actualizar');
const selectOperacion = document.getElementById('select-operacion');
const formActualizar = document.getElementById('form-actualizar-sp');

const inputDescripcion = document.getElementById('input-descripcion');
const inputNombreMaquina = document.getElementById('input-nombre-maquina');
const inputClaveMaquina = document.getElementById('input-clave-maquina');
const inputTiempoMaquina = document.getElementById('input-tiempo-maquina');
const inputPiezasTotales = document.getElementById('input-piezas-totales');

const inputClaveMp = document.getElementById('input-clave-mp');
const inputMaterial = document.getElementById('input-material');

// NUEVO: input para actualizar Clave SP
const inputClaveSp = document.getElementById('input-clave-sp');

// Abrir modal
btnActualizar.addEventListener('click', async () => {
  modalActualizar.style.display = 'flex';
  await llenarSelectSp('select-actualizar');
});

// Cerrar modal
cerrarModalActualizar.addEventListener('click', () => {
  modalActualizar.style.display = 'none';
  formActualizar.reset();
  selectActualizar.selectedIndex = 0;
  selectOperacion.innerHTML = '<option value="">Seleccione una operación</option>';
});

// Al seleccionar SP
selectActualizar.addEventListener('change', async () => {
  const clave = selectActualizar.value;
  if (!clave) return;

  const res = await fetch(`/api/sp/${clave}`);
  const sp = await res.json();

  selectOperacion.innerHTML = '<option value="">Seleccione una operación</option>';
  sp.Operaciones.forEach((op, index) => {
    const option = document.createElement('option');
    option.value = index;
    option.textContent = op.Operacion;
    selectOperacion.appendChild(option);
  });

  selectOperacion.dataset.sp = JSON.stringify(sp);

  inputDescripcion.value = sp.Descripcion || '';
  inputPiezasTotales.value = sp.Piezas_Totales || 0;
  inputClaveMp.value = sp.Clave_Mp || '';
  inputMaterial.value = sp.Material || '';
  inputClaveSp.value = sp.Clave_Sp || '';  // ← NUEVO: cargar clave SP actual en el input
});

// Al seleccionar operación
selectOperacion.addEventListener('change', () => {
  const sp = JSON.parse(selectOperacion.dataset.sp);
  const index = selectOperacion.value;
  if (index === '') return;

  const operacion = sp.Operaciones[index];
  inputNombreMaquina.value = operacion.Nombre_Maquina;
  inputClaveMaquina.value = operacion.Clave_Maquina;
  inputTiempoMaquina.value = operacion.Tiempo_Maquina;
});

// Al guardar cambios
formActualizar.addEventListener('submit', async (e) => {
  e.preventDefault();

  const claveSp = selectActualizar.value;
  const index = selectOperacion.value;

  const updatedFields = {
    nueva_clave_sp: inputClaveSp.value,  // ← NUEVO campo para cambiar Clave SP
    nombre_maquina: inputNombreMaquina.value,
    clave_maquina: inputClaveMaquina.value,
    tiempo_maquina: inputTiempoMaquina.value,
    descripcion: inputDescripcion.value,
    piezas_totales: Number(inputPiezasTotales.value),
    operacionIndex: Number(index),
    clave_mp: inputClaveMp.value,
    material: inputMaterial.value
  };

  try {
    const res = await fetch(`/api/sp/${claveSp}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(updatedFields)
    });

    if (res.ok) {
      alert('Datos actualizados correctamente');
      modalActualizar.style.display = 'none';
      await cargarRegistros();
    } else {
      alert('Error al actualizar SP');
    }
  } catch (err) {
    console.error('Error en actualización:', err);
  }
});

setInterval(cargarRegistros, 2500);
</script>
</body>
</html>
