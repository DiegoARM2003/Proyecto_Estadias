<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Panel de Administración</title>
  <link rel="stylesheet" href="css/pantalla_principal.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>
<body>

  <header>
    <h2 id="welcome-text">Bienvenido</h2>
    <div style="display: flex; gap: 20px;">
      <a href="/base_datos.html" style="color: white; text-decoration: none;"><strong>Base de Datos</strong></a>
      <a href="/cuarta_pantalla.html" style="color: white; text-decoration: none;"><strong>SP'S Fecha</strong></a>
      <a href="/terciaria.html" style="color: white; text-decoration: none;"><strong>Fabricadas</strong></a>
      <a href="/login.html" style="color: white; text-decoration: none;"><strong>Cerrar sesión</strong></a>
    </div>
  </header>

  <!-- Botones alineados a la derecha -->
  <div class="admin-buttons">
      <button id="btn-agregar"><i class="fas fa-check"></i> <strong>AGREGAR</strong></button>
      <button id="btn-actualizar"><i class="fas fa-sync-alt"></i> <strong>ACTUALIZAR</strong></button>
      <button id="btn-nuevo"><i class="fas fa-plus"></i> <strong>NUEVO</strong></button>
  </div>

   <!-- Modal Nuevo -->
<div id="modal-nuevo" class="modal">
  <div class="modal-content modal-nuevo-ancho">
    <h2>Agregar nuevo SP</h2>
    <form id="form-sp">
      <div class="grid-2-cols">
        <div class="col">
          <label>Clave SP:</label> 
          <input type="text" name="Clave_Sp" class="input-compact" required />

          <label>Clave MP:</label>
          <input type="text" name="Clave_Mp" class="input-compact" required />
        </div>

        <div class="col">
          <label>Descripción:</label>
          <input type="text" name="Descripcion" class="input-compact" required />

          <label>Material:</label>
          <input type="text" name="Material" class="input-compact" required />
        </div>
      </div>

      <hr>
      <div id="operaciones-container" class="operaciones-grid">
        <h3>Operaciones</h3>
      </div>

      <div class="grupo-botones">
      <button type="button" id="agregar-operacion"><strong>+ Agregar Operación</strong></button>
      <button type="button" id="eliminar-operacion"><strong>- Eliminar Operación</strong></button>

      <div class="modal-buttons">
        <button type="submit"><strong>Guardar</strong></button>
        <button type="button" id="cerrar-modal"><strong>Cancelar</strong></button>
      </div>
      </div>
    </form>
  </div>
</div>

<!-- Modal Agregar -->
<div id="modal-agregar" class="modal" style="display:none;">
  <div class="modal-content">
    <h2>Agregar SP</h2>
    <form id="form-agregar-sp">

      <div class="modal-grid">
        <div class="field-group">
          <!-- Autocompletar por Clave -->
          <label for="input-clave-sp">Clave SP:</label>
          <input type="text" id="input-clave-sps" placeholder="Escribe clave..." list="datalist-claves" required />
          <datalist id="datalist-claves"></datalist>

          <!-- Autocompletar por Descripción -->
          <label for="input-desc-sp">Descripción:</label>
          <input type="text" id="input-desc-sp" placeholder="Escribe descripción..." list="datalist-descs" />
          <datalist id="datalist-descs"></datalist>

          <label for="fecha-sp">Fecha:</label>
          <input type="date" id="fecha-sp" required />

          <label for="piezas-totales">Piezas Totales:</label>
          <input type="number" id="piezas-totales" required min="1" />

          <label for="clave-mp">Clave MP:</label>
          <input type="text" id="clave-mp" readonly />
        </div>

        <div class="field-group">
          <label for="op1">Operación:</label>
          <input type="text" id="op1" readonly />

          <label for="maquina1">Nombre Máquina:</label>
          <input type="text" id="maquina1" readonly />

          <label for="clave1">Clave Máquina:</label>
          <input type="text" id="clave1" readonly />

          <label for="tiempo1">Tiempo Máquina:</label>
          <input type="text" id="tiempo1" readonly />

          <label for="material">Material:</label>
          <input type="text" id="material" readonly />
        </div>
      </div>

      <div class="modal-buttons">
        <button type="submit"><strong>Guardar</strong></button>
        <button type="button" id="cerrar-modal-agregar"><strong>Cancelar</strong></button>
      </div>
    </form>
  </div>
</div>

<!-- Modal Actualizar -->
<div id="modal-actualizar" class="modal">
  <div class="modal-content">
    <h2>Actualizar SP</h2>
    <form id="form-actualizar-sp">
         <div class="grid-2-cols">
        <div class="field-group">
          <label>Selecciona SP:</label> 
          <select id="select-actualizar" required></select>

          <label>Actualizar Clave SP:</label>
          <input type="text" id="input-clave-sp" required />

          <label>Selecciona Operación:</label>
          <select id="select-operacion" required></select>
        </div>

        <!-- Columna derecha con 2 elementos -->
        <div class="field-group">
          <label>Descripción:</label>
          <input type="text" id="input-descripcion" required />

          <label>Fecha:</label>
          <input type="date" id="input-fecha" required />
        </div>
      </div>

      <div class="grid-2-cols">
        <div>
          <label>Nombre Máquina:</label>
          <input type="text" id="input-nombre-maquina" required />

          <label>Tiempo Máquina:</label>
          <input type="text" id="input-tiempo-maquina" required />

          <label>Clave MP:</label>
          <input type="text" id="input-clave-mp" required />
        </div>
        <div>
          <label>Clave Máquina:</label>
          <input type="text" id="input-clave-maquina" required />

          <label>Piezas Totales:</label>
          <input type="number" id="input-piezas-totales" required />

          <label>Material:</label>
          <input type="text" id="input-material" required />
        </div>
      </div>  

      <div class="modal-buttons">
        <button type="submit"><strong>Guardar</strong></button>
        <button type="button" id="cerrar-modal-actualizar"><strong>Cancelar</strong></button>
      </div>
    </form>
  </div>
</div>


<div class="tabla-wrapper">
  <table class="data-table">
    <thead>
      <tr>
        <th><strong>CLAVE SP</strong></th>
        <th><strong>DESCRIPCIÓN</strong></th>
        <th><strong>CLAVE MAQUINA</strong></th>
        <th><strong>NOMBRE MAQUINA</strong></th>
        <th><strong>TIEMPO MAQUINA</strong></th>
        <th><strong>OPERACIÓN</strong></th>
        <th><strong>OPERACIÓN ACTUAL</strong></th>
        <th><strong>CLAVE MP</strong></th>
        <th><strong>MATERIAL</strong></th>
        <th><strong>FECHA DE AJUSTE</strong></th>
        <th><strong>ALERTA</strong></th>
        <th><strong>PIEZAS TOTALES</strong></th>
        <th><strong>PIEZAS FALTANTES</strong></th>
        <th><strong>PIEZAS COMPLETADAS</strong></th>
        <th><strong>PROGRESO</strong></th>
        <th><strong>ACCIONES</strong></th>
      </tr>
    </thead>
    <tbody id="tabla-registros">
      <!-- Rellenado por JS -->
    </tbody>
  </table>
</div>

<script>

  function mostrarAlertaPersonalizada(mensaje) {
  const alerta = document.createElement('div');
  alerta.textContent = mensaje;
  alerta.style.position = 'fixed';
  alerta.style.top = '20px';
  alerta.style.left = '50%';
  alerta.style.transform = 'translateX(-50%)';
  alerta.style.backgroundColor = '#ff4d4d';
  alerta.style.color = '#fff';
  alerta.style.padding = '12px 20px';
  alerta.style.borderRadius = '6px';
  alerta.style.boxShadow = '0 0 10px rgba(0,0,0,0.2)';
  alerta.style.zIndex = '9999';
  alerta.style.fontWeight = 'bold';
  document.body.appendChild(alerta);

  setTimeout(() => {
    alerta.remove();
  }, 2500);
}

  // Mostrar nombre del usuario
  const nombre = localStorage.getItem('nombre');
  const welcomeText = document.getElementById('welcome-text');
  welcomeText.textContent = nombre ? `Bienvenido, ${nombre}` : 'Bienvenido';

async function cargarRegistros() {
  try {
    const res = await fetch('/api/registros');
    if (!res.ok) {
      console.error('Error al obtener registros:', res.status);
      return;
    }

    const data = await res.json();
    const tablaBody = document.getElementById('tabla-registros');
    if (!tablaBody) {
      console.error('No se encontró <tbody id="tabla-registros"> en el HTML');
      return;
    }

    // Agrupar registros por Clave_Sp
    const agrupados = {};
    data.forEach(registro => {
      if (registro.Oculto) return;
      if (!agrupados[registro.Clave_Sp]) {
        agrupados[registro.Clave_Sp] = [];
      }
      agrupados[registro.Clave_Sp].push(registro);
    });

    // Crear filas una por SP
    const filas = [];

    Object.values(agrupados).forEach(registrosSP => {
      // Ordenar operaciones por número de paso
      registrosSP.sort((a, b) => {
        const getPasoNum = op => parseInt(op?.Operacion?.match(/\d+/)?.[0] || 0);
        return getPasoNum(a) - getPasoNum(b);
      });

      const pasoActual = registrosSP.find(r => r.Progreso < 100) || registrosSP[registrosSP.length - 1];
      const progresoPorcentaje = Math.min(100, Math.max(0, Math.round(pasoActual.Progreso)));
      const fechaRegistro = pasoActual.Fecha ? pasoActual.Fecha.slice(0, 10) : '';
      const fechaTexto = fechaRegistro ? fechaRegistro.split('-').reverse().join('/') : '';

      // Crear la fila HTML y asociarla a su fecha
      const hoy = new Date().toISOString().split('T')[0]; // yyyy-mm-dd
    let alertaTexto = '';
    let alertaColor = '';

    if (pasoActual.Fecha) {
      const fechaSp = pasoActual.Fecha.slice(0, 10); // yyyy-mm-dd

      if (fechaSp < hoy) {
        alertaTexto = 'VENCIDO';
        alertaColor = 'red';
      } else if (fechaSp === hoy) {
        alertaTexto = 'HOY';
        alertaColor = 'black';
      } else {
        alertaTexto = 'VIGENTE';
        alertaColor = '#008F39';
      }
    }

    filas.push({
      fecha: pasoActual.Fecha || '0000-00-00T00:00:00',
      html: `
        <tr>
          <td>${pasoActual.Clave_Sp}</td>
          <td>${pasoActual.Descripcion || ''}</td>
          <td>${pasoActual.Clave_Maquina || ''}</td>
          <td>${pasoActual.Nombre_Maquina || ''}</td>
          <td>${pasoActual.Tiempo_Maquina || ''} MIN</td>
          <td>${pasoActual.Operacion || ''}</td>
          <td>${pasoActual.Operacion_Actual || ''}</td>
          <td>${pasoActual.Clave_Mp || ''}</td>
          <td>${pasoActual.Material || ''}</td>
          <td>${fechaTexto}</td>
          <td style="color:${alertaColor}; font-weight: bold;">${alertaTexto}</td>
          <td>${pasoActual.Piezas_Totales != null ? pasoActual.Piezas_Totales : 0}</td>
          <td>${pasoActual.Piezas_Faltantes != null ? pasoActual.Piezas_Faltantes : 0}</td>
          <td>${pasoActual.Piezas_Completadas != null ? pasoActual.Piezas_Completadas : 0}</td>
          <td>
            <div class="progress-wrapper">
              <div class="progress-text">${progresoPorcentaje}%</div>
              <div class="progress-bar-container">
                <div class="progress-bar ${progresoPorcentaje === 100 ? 'red' : ''}" style="width:${progresoPorcentaje}%"></div>
              </div>
            </div>
          </td>
          <td>
            <button class="btn-borrar-fila" title="Eliminar fila">🗑️</button>
          </td>
        </tr>
        `
      });
    });

    // ✅ Ordenar por fecha ascendente (más antigua primero)
    filas.sort((a, b) => new Date(a.fecha) - new Date(b.fecha));

    // Agregar filas al DOM
    tablaBody.innerHTML = filas.map(f => f.html).join('');

  } catch (err) {
    console.error('Error al cargar la tabla:', err);
  }
}

  document.addEventListener('DOMContentLoaded', cargarRegistros);


  // ==== MANEJO DEL MODAL "NUEVO" ====

  const btnNuevo = document.getElementById('btn-nuevo');
  const modalNuevo = document.getElementById('modal-nuevo');
  const cerrarModalNuevo = document.getElementById('cerrar-modal');
  const form = document.getElementById('form-sp');
  const operacionesContainer = document.getElementById('operaciones-container');
  const agregarOperacionBtn = document.getElementById('agregar-operacion');
  const eliminarOperacionBtn = document.getElementById('eliminar-operacion');

  btnNuevo.addEventListener('click', () => {
    modalNuevo.style.display = 'flex';
    operacionesContainer.innerHTML = '';
    agregarOperacion(); // al menos una operación por defecto
  });

  cerrarModalNuevo.addEventListener('click', () => {
    modalNuevo.style.display = 'none';
  });

  agregarOperacionBtn.addEventListener('click', agregarOperacion);
  eliminarOperacionBtn.addEventListener('click', eliminarOperacion);

  function agregarOperacion() { 
  const div = document.createElement('div');
  div.classList.add('operacion-box');
  div.innerHTML = `
    <div>
      <label>Operación:</label>
      <input type="text" name="Operacion" required>
    </div>
    <div>
      <label>Nombre Máquina:</label>
      <input type="text" name="Nombre_Maquina" required>
    </div>
    <div>
      <label>Clave Máquina:</label>
      <input type="text" name="Clave_Maquina" required>
    </div>
    <div>
      <label>Tiempo Máquina:</label>
      <input type="text" name="Tiempo_Maquina" required>
    </div>
  `;
  operacionesContainer.appendChild(div);
}


  function eliminarOperacion() {
  const operaciones = document.querySelectorAll('.operacion-box');
  if (operaciones.length > 1) {
    operaciones[operaciones.length - 1].remove();
  } else {
    mostrarAlertaPersonalizada('Debe haber al menos una operación registrada.');
  }
}

  form.addEventListener('submit', async (e) => {
    e.preventDefault();

    const formData = new FormData(form);
    const sp = {
      Clave_Sp: formData.get('Clave_Sp'),
      Descripcion: formData.get('Descripcion'),
      Clave_Mp: formData.get('Clave_Mp'),  // ✅ Clave correcta
      Material: formData.get('Material'),
      Operaciones: []
    };

    const ops = operacionesContainer.querySelectorAll('div');
    ops.forEach(op => {
      const inputs = op.querySelectorAll('input');
      sp.Operaciones.push({
        Operacion: inputs[0].value,
        Nombre_Maquina: inputs[1].value,
        Clave_Maquina: inputs[2].value,
        Tiempo_Maquina: inputs[3].value
      });
    });

    try {
      const res = await fetch('/api/sp', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(sp)
      });

      if (res.ok) {
        form.reset();
        modalNuevo.style.display = 'none';
        await cargarRegistros();
        await llenarSelectSp('select-agregar');
        await llenarSelectSp('select-actualizar');
      } else {
        alert('Error al guardar el SP');
      }
    } catch (err) {
      console.error('Error al enviar SP:', err);
    }
  });

// MODAL AGREGAR A LA TABLA //
  const btnAgregar = document.getElementById('btn-agregar');
  const modalAgregar = document.getElementById('modal-agregar');
  const cerrarModalAgregar = document.getElementById('cerrar-modal-agregar');

  const inputClaveSps = document.getElementById('input-clave-sps');
  const inputDescSp = document.getElementById('input-desc-sp');
  const datalistClaves = document.getElementById('datalist-claves');
  const datalistDescs = document.getElementById('datalist-descs');

  const piezasTotales = document.getElementById('piezas-totales');
  const descSp = document.getElementById('input-desc-sp');
  const op1 = document.getElementById('op1');
  const maquina1 = document.getElementById('maquina1');
  const clave1 = document.getElementById('clave1');
  const tiempo1 = document.getElementById('tiempo1');
  const claveMp = document.getElementById('clave-mp');
  const material = document.getElementById('material');

  let listaSPs = [];

  btnAgregar.addEventListener('click', async () => {
    modalAgregar.style.display = 'flex';
    await cargarSPs();
    limpiarCampos();
  });

  cerrarModalAgregar.addEventListener('click', () => {
    modalAgregar.style.display = 'none';
    document.getElementById('form-agregar-sp').reset();
    limpiarCampos();
  });

  function limpiarCampos() {
    inputClaveSps.value = '';
    inputDescSp.value = '';
    piezasTotales.value = '';
    op1.value = '';
    maquina1.value = '';
    clave1.value = '';
    tiempo1.value = '';
    claveMp.value = '';
    material.value = '';
  }

  async function cargarSPs() {
    try {
      const res = await fetch('/api/sp');
      listaSPs = await res.json();
    } catch (err) {
      console.error('Error al cargar SPs:', err);
    }
  }

  inputClaveSps.addEventListener('input', () => {
    const texto = inputClaveSps.value.toLowerCase();
    datalistClaves.innerHTML = '';
    const filtrados = listaSPs.filter(sp => sp.Clave_Sp.toLowerCase().includes(texto));
    filtrados.forEach(sp => {
      const option = document.createElement('option');
      option.value = sp.Clave_Sp;
      datalistClaves.appendChild(option);
    });
  });

  inputDescSp.addEventListener('input', () => {
    const texto = inputDescSp.value.toLowerCase();
    datalistDescs.innerHTML = '';
    const filtrados = listaSPs.filter(sp => sp.Descripcion?.toLowerCase().includes(texto));
    filtrados.forEach(sp => {
      const option = document.createElement('option');
      option.value = sp.Descripcion;
      datalistDescs.appendChild(option);
    });
  });

  inputClaveSps.addEventListener('change', () => {
    const sp = listaSPs.find(s => s.Clave_Sp === inputClaveSps.value);
    if (sp) completarCampos(sp);
  });

  inputDescSp.addEventListener('change', () => {
    const sp = listaSPs.find(s => s.Descripcion === inputDescSp.value);
    if (sp) completarCampos(sp);
  });

  function completarCampos(sp) {
    inputClaveSps.value = sp.Clave_Sp || '';
    inputDescSp.value = sp.Descripcion || '';
    op1.value = sp.Operaciones?.map(op => op.Operacion).join(', ') || '';
    maquina1.value = sp.Operaciones?.[0]?.Nombre_Maquina || '';
    clave1.value = sp.Operaciones?.[0]?.Clave_Maquina || '';
    tiempo1.value = sp.Operaciones?.[0]?.Tiempo_Maquina || '';
    claveMp.value = sp.Clave_Mp || '';
    material.value = sp.Material || '';
  }

  document.getElementById('form-agregar-sp').addEventListener('submit', async (e) => {
    e.preventDefault();

    const clave = inputClaveSps.value;
    const piezas = parseInt(piezasTotales.value);
    const fecha = document.getElementById('fecha-sp').value;

    if (!clave || isNaN(piezas) || piezas <= 0 || !fecha) {
      return alert('Completa todos los campos, incluyendo la fecha.');
    }

    try {
      const res = await fetch(`/api/sp/piezas/${clave}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          piezasTotales: piezas,
          piezasFaltantes: piezas,
          piezasCompletadas: 0,
          progreso: 0,
          fecha,
          Oculto: false
        })
      });

      if (res.ok) {
        alert('SP agregado correctamente');
        modalAgregar.style.display = 'none';
        document.getElementById('form-agregar-sp').reset();
        limpiarCampos();
        await cargarSPs();
        inputClaveSps.value = '';
        inputDescSp.value = '';
      } else {
        alert('Error al guardar SP');
      }
    } catch (err) {
      console.error('Error al guardar:', err);
    }
  });


// Modal actualizar//  
const modalActualizar = document.getElementById('modal-actualizar');
const btnActualizar = document.getElementById('btn-actualizar');
const cerrarModalActualizar = document.getElementById('cerrar-modal-actualizar');

const selectActualizar = document.getElementById('select-actualizar');
const selectOperacion = document.getElementById('select-operacion');
const formActualizar = document.getElementById('form-actualizar-sp');

const inputDescripcion = document.getElementById('input-descripcion');
const inputNombreMaquina = document.getElementById('input-nombre-maquina');
const inputClaveMaquina = document.getElementById('input-clave-maquina');
const inputTiempoMaquina = document.getElementById('input-tiempo-maquina');
const inputPiezasTotales = document.getElementById('input-piezas-totales');
const inputClaveMp = document.getElementById('input-clave-mp');
const inputMaterial = document.getElementById('input-material');
const inputFecha = document.getElementById('input-fecha');
const inputClaveSp = document.getElementById('input-clave-sp');

// 🔄 Llena el select solo con SPs visibles en la tabla
async function llenarSelectSp(selectId) {
  try {
    const select = document.getElementById(selectId);
    const tbody = document.querySelector('#tabla-registros');

    if (!tbody) {
      console.warn('No se encontró el cuerpo de la tabla');
      return;
    }

    const filas = tbody.querySelectorAll('tr');
    if (filas.length === 0) {
      console.warn('La tabla no tiene registros visibles');
      return;
    }

    // Limpiar el select
    select.innerHTML = '<option value="">Seleccione un SP</option>';
    const clavesAgregadas = new Set();

    filas.forEach(fila => {
      const celdas = fila.querySelectorAll('td');
      const claveSp = celdas[0]?.textContent?.trim(); // Primera celda = Clave SP

      if (claveSp && !clavesAgregadas.has(claveSp)) {
        const option = document.createElement('option');
        option.value = claveSp;
        option.textContent = claveSp;
        select.appendChild(option);
        clavesAgregadas.add(claveSp);
      }
    });

    if (clavesAgregadas.size === 0) {
      const option = document.createElement('option');
      option.disabled = true;
      option.textContent = 'No hay SPs en la tabla';
      select.appendChild(option);
    }
  } catch (error) {
    console.error('Error al llenar el select desde la tabla:', error);
  }
}

// Abrir modal
btnActualizar.addEventListener('click', async () => {
  modalActualizar.style.display = 'flex';
  await llenarSelectSp('select-actualizar');
});

// Cerrar modal
cerrarModalActualizar.addEventListener('click', () => {
  modalActualizar.style.display = 'none';
  formActualizar.reset();
  selectActualizar.selectedIndex = 0;
  selectOperacion.innerHTML = '<option value="">Seleccione una operación</option>';
});

// Al seleccionar SP
selectActualizar.addEventListener('change', async () => {
  const clave = selectActualizar.value;
  if (!clave) return;

  try {
    const res = await fetch(`/api/sp/${clave}`);
    const sp = await res.json();

    selectOperacion.innerHTML = '<option value="">Seleccione una operación</option>';
    sp.Operaciones.forEach((op, index) => {
      const option = document.createElement('option');
      option.value = index;
      option.textContent = op.Operacion;
      selectOperacion.appendChild(option);
    });

    selectOperacion.dataset.sp = JSON.stringify(sp);

    inputDescripcion.value = sp.Descripcion || '';
    inputPiezasTotales.value = sp.Piezas_Totales || 0;
    inputClaveMp.value = sp.Clave_Mp || '';
    inputMaterial.value = sp.Material || '';
    inputClaveSp.value = sp.Clave_Sp || '';
    inputFecha.value = sp.Fecha ? sp.Fecha.slice(0, 10) : '';
  } catch (err) {
    console.error('Error al obtener SP:', err);
  }
});

// Al seleccionar operación
selectOperacion.addEventListener('change', () => {
  const sp = JSON.parse(selectOperacion.dataset.sp);
  const index = selectOperacion.value;
  if (index === '') return;

  const operacion = sp.Operaciones[index];
  inputNombreMaquina.value = operacion.Nombre_Maquina;
  inputClaveMaquina.value = operacion.Clave_Maquina;
  inputTiempoMaquina.value = operacion.Tiempo_Maquina;
});

// Al guardar cambios
formActualizar.addEventListener('submit', async (e) => {
  e.preventDefault();

  const claveSp = selectActualizar.value;
  const index = selectOperacion.value;

  const updatedFields = {
    nueva_clave_sp: inputClaveSp.value,
    nombre_maquina: inputNombreMaquina.value,
    clave_maquina: inputClaveMaquina.value,
    tiempo_maquina: inputTiempoMaquina.value,
    descripcion: inputDescripcion.value,
    piezas_totales: Number(inputPiezasTotales.value),
    operacionIndex: Number(index),
    clave_mp: inputClaveMp.value,
    material: inputMaterial.value,
    fecha: inputFecha.value
  };

  try {
    const res = await fetch(`/api/sp/${claveSp}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(updatedFields)
    });

    if (res.ok) {
      alert('Datos actualizados correctamente');
      modalActualizar.style.display = 'none';
      await cargarRegistros();
    } else {
      alert('Error al actualizar SP');
    }
  } catch (err) {
    console.error('Error en actualización:', err);
  }
});

setInterval(cargarRegistros, 2500);

// Escuchar clics en botones de eliminar fila y enviar petición al backend
document.addEventListener('click', async function (e) {
  if (e.target && e.target.classList.contains('btn-borrar-fila')) {
    const fila = e.target.closest('tr');
    const claveSp = fila?.querySelector('td')?.textContent?.trim(); // Se asume que la Clave_Sp está en la primera columna

    if (!claveSp) {
      console.error('No se pudo obtener la Clave_SP');
      return;
    }

    const confirmar = confirm(`¿Seguro que deseas eliminar el SP ${claveSp}?`);
    if (!confirmar) return;

    try {
      const res = await fetch(`/api/sp/${claveSp}/ocultar`, {
        method: 'POST'
      });

      if (res.ok) {
        fila.remove();
      } else {
        mostrarAlertaPersonalizada('No se pudo ocultar el SP en el backend');
        console.error('Error del servidor:', res.status);
      }
    } catch (err) {
      console.error('Error al enviar petición de borrado:', err);
    }
  }
});
</script>
</body>
</html>
