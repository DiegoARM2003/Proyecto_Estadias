<!DOCTYPE html> 
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>BASE DE DATOS</title>
  <link rel="stylesheet" href="css/bd.css" />
</head>
<body>
  <header>
    <h1>BASE DE DATOS</h1>
     <div style="display: flex; gap: 20px;">
      <a href="/principal.html" style="color: white; text-decoration: none;"><strong>Principal</strong></a>
      <a href="/login.html" style="color: white; text-decoration: none;"><strong>Cerrar sesi√≥n</strong></a>
    </div>
  </header>
  

  <div class="barra-superior">
  <div class="contenedor-buscador"> 
    <input type="text" id="buscador" placeholder="Buscar.....">
    <span class="icono-lupa">üîç</span>
  </div>

  <form id="form-subir-excel" enctype="multipart/form-data">
    <label for="archivoExcel" class="btn-subir-excel">
      üì§ Subir Excel
    </label>
    <input type="file" id="archivoExcel" name="archivo" accept=".xlsx, .xls" required>
  </form>
  </div>

  <div id="mensajeExcel"></div>

  <table>
    <thead>
      <tr>
        <th>Clave SP</th>
        <th>Descripci√≥n</th>
        <th>Clave M√°quina</th>
        <th>Nombre M√°quina</th>
        <th>Tiempo M√°quina</th>
        <th>Operaci√≥n</th>
        <th>Clave MP</th>
        <th>Material</th>
      </tr>
    </thead>
    <tbody id="tabla-todos-sps">
      <!-- SPs ser√°n insertados aqu√≠ -->
    </tbody>
  </table>

<style>
  /* Mensaje flotante */
  #mensajeExcel {
    position: fixed;
    top: 20px;
    right: 20px;
    background: #333;
    color: white;
    padding: 10px 20px;
    border-radius: 8px;
    font-weight: bold;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.4s ease-in-out;
    z-index: 9999;
  }
  #mensajeExcel.visible {
    opacity: 1;
  }
</style>

<script> 
  let datosOriginales = [];

  async function cargarSPsPaso1() {
    try {
      const res = await fetch('/api/sp');
      const sps = await res.json();

      datosOriginales = sps
        .filter(sp => (sp.Operaciones || []).some(op => op.Operacion?.toLowerCase() === 'paso 1'))
        .map(sp => {
          const paso1 = sp.Operaciones.find(op => op.Operacion?.toLowerCase() === 'paso 1');
          return {
            Clave_Sp: sp.Clave_Sp || '',
            Descripcion: sp.Descripcion || '',
            Clave_Maquina: paso1?.Clave_Maquina || '',
            Nombre_Maquina: paso1?.Nombre_Maquina || '',
            Tiempo_Maquina: paso1?.Tiempo_Maquina || '',
            Operacion: paso1?.Operacion || '',
            Clave_Mp: sp.Clave_Mp || '',
            Material: sp.Material || ''
          };
        });

      mostrarSPs(datosOriginales);
    } catch (error) {
      console.error('Error al cargar SPs:', error);
    }
  }

  function mostrarSPs(lista) {
    const tbody = document.getElementById('tabla-todos-sps');
    tbody.innerHTML = '';

    if (lista.length === 0) {
      const fila = document.createElement('tr');
      fila.innerHTML = `
        <td colspan="8" style="text-align: center; padding: 12px; font-weight: bold;">
          No se encontraron resultados
        </td>
      `;
      tbody.appendChild(fila);
      return;
    }

    lista.forEach(sp => {
      const fila = document.createElement('tr');
      fila.innerHTML = `
        <td>${sp.Clave_Sp}</td>
        <td>${sp.Descripcion}</td>
        <td>${sp.Clave_Maquina}</td>
        <td>${sp.Nombre_Maquina}</td>
        <td>${sp.Tiempo_Maquina} MIN</td>
        <td>${sp.Operacion}</td>
        <td>${sp.Clave_Mp}</td>
        <td>${sp.Material}</td>
      `;
      tbody.appendChild(fila);
    });
  }

  document.getElementById('buscador').addEventListener('input', function () {
    const texto = this.value.toLowerCase();
    const filtrados = datosOriginales.filter(sp =>
      Object.values(sp).some(valor =>
        valor.toString().toLowerCase().includes(texto)
      )
    );
    mostrarSPs(filtrados);
  });

  function mostrarMensaje(texto, color = 'green') {
    const mensajeDiv = document.getElementById('mensajeExcel');
    mensajeDiv.innerText = texto;
    mensajeDiv.style.background = color === 'green' ? '#4CAF50' : '#E53935';
    mensajeDiv.classList.add('visible');

    setTimeout(() => {
      mensajeDiv.classList.remove('visible');
    }, 3000); // Se oculta en 3 segundos
  }

  // üì§ Subir archivo Excel
  document.getElementById('archivoExcel').addEventListener('change', async function () {
    const archivo = this.files[0];
    if (!archivo) return;

    const formData = new FormData();
    formData.append('archivo', archivo);

    mostrarMensaje('‚è≥ Subiendo archivo...', '#FFA000');

    try {
      const res = await fetch('/api/subir-excel', {
        method: 'POST',
        body: formData
      });

      const data = await res.json();

      if (res.ok) {
        mostrarMensaje('‚úÖ ' + data.message, 'green');
        await cargarSPsPaso1(); // Recargar tabla
      } else {
        mostrarMensaje('‚ùå Error: ' + (data.error || 'No se pudo importar'), 'red');
      }
    } catch (error) {
      console.error('Error al subir archivo:', error);
      mostrarMensaje('‚ùå Error al subir archivo', 'red');
    }
  });

  window.onload = cargarSPsPaso1;
</script>

<!-- El mensaje flotante -->
<div id="mensajeExcel"></div>
</body>
</html>
